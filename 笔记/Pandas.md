# Pandas 数据分析库

## 基础概念

------

#### DataFrame

Pandas 中的基本数据结构，是一个二维标签化数据结构，可以看作是一个表格，其中包含行和列

-   行索引： `df.index`
-   列索引： `df.columns`
-   数据体本身： `df.values` 或者 `df.to_numpy()`

#### Serise

一维标签化数组，可以看作是 DataFrame 中的单一列

-   Series可以类似List或者Dict一样访问

#### 安装 Pandas

```python
pip install pandas
```

#### 导入 Pandas

```python
import pandas as pd
```



## 读写文件

------

### 文件读取

#### CSV 文件

```python
df = pd.read_csv('file.csv')
```

-   `header` ：用于指定列名所在的行，默认为 0
-   `index_col` ：用于指定行索引的列
-   `dtype` ：用于指定某列的数据类型
-   `na_values` ：用于指定缺失值的表示方式

#### Excel 文件

```python
df = pd.read_excel('file.xlsx', sheet_name='Sheet1')
```

-   `sheet_name` ：用于指定工作表的名称或索引
-   `index_col` ：用于指定行索引的列
-   `dtype` ：用于指定某列的数据类型
-   `na_values` ：用于指定缺失值的表示方式

#### TXT 文件

```python
df = pd.read_csv(file, sep="\t", header=None, names=["学号", "年龄", "性别"])
```

-   `sep` ：用于指定分隔符，通常是制表符（ `\t` ）
-   `header` ：用于指定列名所在的行，默认为 0
-   `names` ：用于指定列名

#### JSON 文件

```python
df = pd.read_json('file.json')
```

-   对于复杂的 JSON 结构，可能需要使用 `json_normalize` 方法

#### SQL 数据库

```python
from sqlalchemy import create_engine
engine = create_engine('sqlite:///database.db')
df = pd.read_sql_query("SELECT * FROM table_name", engine)
```

-   需要使用 SQLAlchemy 库创建一个数据库引擎

### 文件导出

#### CSV 文件

```python
df.to_csv('file.csv', index=False)
```

-   `index` ：用于指定是否包含行索引，默认为 True

#### Excel 文件

```python
df.to_excel('file.xlsx', sheet_name='Sheet1', index=False)
```

-   `sheet_name` ：用于指定工作表的名称
-   `index` ：用于指定是否包含行索引，默认为 True

#### JSON 文件

```python
df.to_json('file.json')
```

-    `orient` ：指定 JSON 的格式

#### HTML 文件

```python
df.to_html('file.html')
```

-    `index` ：控制是否显示行索引

#### SQL 数据库

```python
df.to_sql('table_name', engine, if_exists='replace', index=False)
```

-   `if_exists` ：用于指定如果表已存在时的行为，如 `replace` 或 `append`。
-   `index` ：用于指定是否包含行索引，默认为 True



## 数据查看

------

### 基本查询方法

| 函数           | 说明                         |
| -------------- | ---------------------------- |
| `df.head(n)`   | 查看 DataFrame 的前 n 行     |
| `df.tail(n)`   | 查看 DataFrame 的后 n 行     |
| `df.sample(n)` | 随机查看 DataFrame 中的 n 行 |

### 数据框架概要信息

| 函数        | 说明                                                         |
| ----------- | ------------------------------------------------------------ |
| `df.info()` | 查看 DataFrame 的概要信息，包括每列的数据类型、非空值的数量、内存使用情况等 |

### 数据统计摘要

| 函数          | 说明                                                         | 示例                                                         |
| ------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| df.describe() | 查看数值型列的统计摘要，包括计数、均值、标准差、最小值、四分位数和最大值 | 还可以指定只查看某些列，如 `df.describe(include=['float64', 'int64'])` |

### 列查看

| 函数         | 说明                      |
| ------------ | ------------------------- |
| `df.columns` | 查看 DataFrame 的所有列名 |

### 行查看

| 函数       | 说明                    |
| ---------- | ----------------------- |
| `df.index` | 查看 DataFrame 的行索引 |

### 唯一值和值计数

| 函数                        | 说明                                                         |
| --------------------------- | ------------------------------------------------------------ |
| `df['列名'].unique()`       | 查看某列的唯一值                                             |
| `df['列名'].nunique()`      | 查看某列的唯一值数量                                         |
| `df['列名'].value_counts()` | 查看某列的值计数。还可以进行排序，如 `df['列名'].value_counts(ascending=True)` |

### 缺失值和重复值

| 函数                   | 说明                                                         |
| ---------------------- | ------------------------------------------------------------ |
| `df.isnull()`          | 查看缺失值                                                   |
| `df['列名'].isnull()`  | 查看缺失值                                                   |
| `df.duplicated()`      | 查看重复行。还可以查看某列的重复值，如 `df['列名'].duplicated()` |
| `df.drop_duplicates()` | 删除重复行。还可以指定只删除某列的重复值，如 `df.drop_duplicates(subset=['列名'])` |

### 数据排序

| 函数                        | 说明                                                         |
| --------------------------- | ------------------------------------------------------------ |
| `df.sort_values(by='列名')` | 根据某列的值对数据进行排序。还可以指定排序方向，如 `df.sort_values(by='列名', ascending=False)` |
| `df.sort_index()`           | 根据索引对数据进行排序。还可以指定排序方向，如 `df.sort_index(ascending=False)` |



##  数据选择

------

### 基于标签的选择

#### `loc` 方法

**作用：** 通过行标签和列名进行数据选择

| 函数                           | 说明           |
| ------------------------------ | -------------- |
| `df.loc[:, '列名']`            | 选择单列       |
| `df.loc[行索引]`               | 选择单行       |
| `df.loc[行索引列表, 列名列表]` | 选择多行和多列 |
| `df.loc[df['列名'] > 值]`      | 条件选择       |

#### `at` 和 `iat` 方法

**作用：** 快速访问单个元素

| at 方法               | iat 方法               |
| --------------------- | ---------------------- |
| `df.at[行索引, 列名]` | `df.iat[行索引, 列名]` |

### 基于整数索引的选择

#### `iloc` 方法

**作用：** 通过整数索引进行数据选择

| 函数                              | 说明           |
| --------------------------------- | -------------- |
| `df.iloc[:, 列索引]`              | 选择单列       |
| `df.iloc[行索引]`                 | 选择单行       |
| `df.iloc[行索引列表, 列索引列表]` | 选择多行和多列 |

### 基于布尔索引的选择

#### 条件表达式

| 函数                  | 说明                       |
| --------------------- | -------------------------- |
| `df[df['列名'] > 值]` | 通过布尔表达式进行数据选择 |

### 选择特定列

#### 直接通过列名

**作用：** 选择单个或多个列

| 函数                     | 说明     |
| ------------------------ | -------- |
| `df['列名']`             | 选择单列 |
| `df[['列名1', '列名2']]` | 选择多列 |

### 选择特定行

#### 切片方法

**作用：** 选择行的子集

| 函数 1                    | 函数 2                  |
| ------------------------- | ----------------------- |
| `df[起始索引 : 结束索引]` | `df['行名1' : '行名2']` |

### 选择数据子集的其他方法

#### `query()` 方法

| 函数                     | 说明                         |
| ------------------------ | ---------------------------- |
| `df.query('列名 > 值')`  | 通过字符串表达式进行数据选择 |
| `df.filter(like='前缀')` | 根据列名的前缀选择列         |
| `df.filter(like='后缀')` | 根据列名的后缀选择列         |

### 注意事项

>   1.   使用 `loc` 和 `iloc` 时，可以通过逗号分隔行和列的选择器。例如，`df.loc[:, ['Column1', 'Column2']]` 选择所有行和 `Column1` 、 `Column2` 两列
>   2.   使用布尔索引时，条件表达式应该与 DataFrame 的大小相匹配



## 数据清洗

------

### 处理缺失值

#### 删除缺失值

| 函数                                 | 说明                   |
| ------------------------------------ | ---------------------- |
| `df.dropna()` 或 `df.dropna(axis=1)` | 删除包含缺失值的行或列 |

#### 填充缺失值

| 函数                        | 说明                 |
| --------------------------- | -------------------- |
| `df.fillna(值)`             | 用指定的值填充缺失值 |
| `df.fillna(method='ffill')` | 前向填充             |

### 处理重复值

#### 删除重复值

| 函数                                                         | 说明                       |
| ------------------------------------------------------------ | -------------------------- |
| `df.drop_duplicates()` 或 `df.drop_duplicates(subset=['列1', '列2'])` | 删除重复的行，还可以指定列 |

### 数据转换

#### 类型转换

| 函数                                         | 说明         |
| -------------------------------------------- | ------------ |
| `df['列名'] = df['列名'].astype('数据类型')` | 转换数据类型 |

#### 替换值

| 函数                                                         | 说明         |
| ------------------------------------------------------------ | ------------ |
| `df.replace(旧值, 新值)` 或 `df.replace({'列名': 旧值}, 新值)` | 替换特定的值 |

### 数据规范化

#### 归一化

```python
# 使用 min-max 规范化将数据缩放到特定范围
df['列名'] = (df['列名'] - df['列名'].min()) / (df['列名'].max() - df['列名'].min())
```

#### 标准化

```python
# 使用 z-score 标准化将数据转换为均值为 0，标准差为 1 的分布
df['列名'] = (df['列名'] - df['列名'].mean()) / df['列名'].std()
```

### 处理异常值

#### 使用 IQR（四分位距）方法

```python
# 计算第一四分位数（Q1）和第三四分位数（Q3），然后计算 IQR（Q3 - Q1）
# 删除小于 Q1 - 1.5 * IQR 或大于 Q3 + 1.5 * IQR 的值
Q1 = df['列名'].quantile(0.25)
Q3 = df['列名'].quantile(0.75)
# 然后删除异常值
```

### 文本数据清洗

#### 删除空格

```python
# 使用 strip() 方法删除字符串头尾的空格
df['列名'] = df['列名'].str.strip()
```

#### 大小写转换

```python
# 使用 lower() 或 upper() 方法转换文本大小写
df['列名'] = df['列名'].str.lower()
```

#### 拆分和合并文本

```python
# 使用 split() 方法拆分字符串
# 使用 join() 方法合并字符串
df['列名'] = df['列名'].str.split().str.join('分隔符')
```

### 日期和时间数据清洗

#### 解析日期

```python
# 使用 to_datetime() 方法将字符串转换为日期时间对象
df['日期列'] = pd.to_datetime(df['日期列'])
```

#### 提取日期部分

```python
# 使用 dt 访问器提取日期的年、月、日等
df['年'] = df['日期列'].dt.year
```



## 数据的分组与聚合

------

### 分组

| 函数                           | 说明                              |
| ------------------------------ | --------------------------------- |
| `df.groupby('列名')`           | 根据一个键将数据分成组            |
| `df.groupby(['列1', '列2'])`   | 根据多个键将数据分成组            |
| `df.groupby(level='索引级别')` | 根据 DataFrame 的索引级别进行分组 |

### 聚合

| 函数                                      | 说明                                                         |
| ----------------------------------------- | ------------------------------------------------------------ |
| `df.groupby('列名').sum()`                | 对分组后的数据应用聚合函数，如 `sum()`、`mean()`、`count()`、`max()`、`min()` 等 |
| `df.groupby('列名').agg(['sum', 'mean'])` | 对分组后的数据应用聚合函数，如 `sum()`、`mean()`、`count()`、`max()`、`min()` 等 |

### 分组级运算

| 函数                                                         | 说明                                           |
| ------------------------------------------------------------ | ---------------------------------------------- |
| `df.groupby('列名')['日期列'].transform(lambda x: (x - x.mean()) / x.std())` | 对分组后的数据进行变换操作，如标准化、归一化等 |
| `df.groupby('列名').filter(lambda x: len(x) > 1)`            | 根据一定的条件过滤分组                         |

### 多索引（MultiIndex）

| 函数                                          | 说明                           |
| --------------------------------------------- | ------------------------------ |
| `df.set_index(['列1', '列2'])`                | 将多个列作为索引，创建多级索引 |
| `df.xs('值1', level='列1', drop_level=False)` | 对多级索引进行切片操作         |

### 透视表（Pivot Tables）

| 函数                                                         | 说明                                                   |
| ------------------------------------------------------------ | ------------------------------------------------------ |
| `pd.pivot_table(df, values='Data Column', index=['Column1'], columns=['Column2'], aggfunc=np.mean)` | 根据一个或多个键对数据进行聚合，并支持行列上的多重汇总 |

### 注意事项

>   1.   在使用 `groupby()` 方法时，选择作为分组依据的列通常是具有重复值的列
>   2.   聚合函数可以同时应用于多个列，返回的结果将是多列的聚合值
>   3.   在进行分组和聚合操作时，需要注意数据类型的一致性，以免出现类型错误



## 时间序列数据

------

### 日期和时间数据

| 函数                           | 说明                                       |
| ------------------------------ | ------------------------------------------ |
| `pd.to_datetime(df['日期列'])` | 将字符串转换为日期时间对象（ `datetime` ） |
| `df.set_index('日期列')`       | 将日期时间列设置为 DataFrame 的索引        |

### 时间序列重采样

| 函数                      | 作用         | 说明                                                   |
| ------------------------- | ------------ | ------------------------------------------------------ |
| `df.resample('M').mean()` | 每月平均     | 将时间序列数据转换为不同频率（如从日数据转换为月数据） |
| `df.shift(1)`             | 向前偏移一天 | 对时间序列数据进行向前或向后偏移                       |

### 时间序列窗口函数

| 函数                                    | 作用         | 说明                           |
| --------------------------------------- | ------------ | ------------------------------ |
| `df['日期列'].rolling(window=3).mean()` | 3 天移动平均 | 对时间序列数据应用滚动窗口函数 |
| `df['日期列'].expanding().mean()`       | 扩展平均     | 对时间序列数据应用扩展窗口函数 |

### 时间序列切片

| 函数                            | 说明                                   |
| ------------------------------- | -------------------------------------- |
| `df['2021-01-01':'2021-12-31']` | 根据时间范围对时间序列数据进行切片     |
| `df.loc['2021-01-01']`          | 根据具体的时间点对时间序列数据进行切片 |

### 时间序列周期性

#### 季节性分解

```python
# 将时间序列数据分解为趋势、季节性和残差三个部分
result = seasonal_decompose(df['日期列'], model='additive', period=12)
```

**模型选择：** 

-   `model` 参数用于选择分解模型，可以是 `additive` （加法模型）或 `multiplicative` （乘法模型）
-   加法模型适用于季节性变化不随时间变化的情况，乘法模型适用于季节性变化随时间变化的情况。

**周期设置：**

-   `period` 参数用于设置季节性周期，通常根据数据的特点和分析的需求来确定

#### 季节性分析

```python
# 提取季节性成分，分析季节性模式
seasonal = result.seasonal
# 绘制季节性成分的图表，以便于可视化分析
seasonal.plot()
```

#### 趋势分析

```python
# 提取趋势成分，分析长期趋势
trend = result.trend
# 绘制趋势成分的图表，以便于可视化分析
trend.plot()
```

#### 残差分析

```python
# 提取残差成分，分析随机波动
resid = result.resid
# 绘制残差成分的图表，以便于可视化分析
resid.plot()
```

### 时间序列绘图

#### 基本时间序列绘图

```python
# 绘制时间序列数据的线图
df['日期列'].plot()
# 设置图表的标题、x轴标签和y轴标签
df['日期列'].plot(title='标题', xlabel='日期', ylabel='值')
# 设置图表的样式，如线型、颜色等
df['日期列'].plot(style='--', color='blue')
```

#### 时间序列子图

```python
# 在同一图表中绘制多个时间序列数据
df[['日期列1', '日期列2']].plot()
# 绘制多个子图，每个子图显示一个时间序列数据
df['日期列1'].plot(subplots=True)
```

#### 时间序列滚动统计

```python
# 绘制时间序列数据的滚动统计，如移动平均
df['日期列'].rolling(window=3).mean().plot()
# 设置滚动统计的样式，如线型、颜色等
df['日期列'].rolling(window=3).mean().plot(style='--', color='red')
```

#### 时间序列周期性分析绘图

```python
# 绘制时间序列数据的季节性分解图表
result = seasonal_decompose(df['日期列'], model='additive', period=12)
result.plot()
```

### 时间序列数据合并

#### `concat()` 方法

**作用：**

-   将多个时间序列数据集垂直或水平地合并
-   适用于具有相同时间索引的数据集

```python
# axis=0 表示垂直合并，即行合并
result = pd.concat([df1, df2], axis=0)
# axis=1 表示水平合并，即列合并
result = pd.concat([df1, df2], axis=1)
```

**参数：**

-   `ignore_index=True` ：忽略原始索引，重新生成从 0 开始的索引。
-   `join='inner'` ：只合并时间戳匹配的行

#### `merge()` 方法

**作用：**

-   将两个或多个时间序列数据集基于特定的键进行合并
-   适用于具有不同时间索引但相关联的数据集

```python
# 基于键的合并
result = pd.merge(df1, df2, on='时间列', how='inner')
```

**参数：**

-   `on` ：用于指定用于合并的键列
-   `how` ：用于指定合并的方式，如 `inner`（交集）、 `outer` （并集）等
-   `suffixes` ：用于指定合并后列名的后缀，以避免列名冲突。
-   `indicator=True` ：添加一个指示列，显示每个值来自哪个输入 DataFrame

### 注意事项

>   1.   在处理时间序列数据时，确保日期时间数据的格式正确无误，否则可能导致分析结果不准确
>   2.   在进行重采样和窗口函数操作时，需要注意时间频率的选择，以适应数据的特点和分析的需求
>   3.   在进行时间序列分析时，了解数据的周期性和趋势对于模型选择和参数调整非常重要



## 进阶话题

------

### 性能优化

#### `eval()` 方法

```python
# 用于执行字符串形式的表达式，提高性能
df[df.eval('列1 > 值')]
```

#### `query()` 方法

```python
# 用于执行字符串形式的查询，提高性能
df.query('列1 > 值')
```

### 数据转换和重塑

#### `melt()` 方法

```python
# 将 DataFrame 转换为长格式（melt）或宽格式（unpivot）
df_melted = df.melt(id_vars=['列1'], var_name='变量', value_name='值')
```

#### `stack()` 和 `unstack()` 方法

```python
# 将 DataFrame 的列转换为行，或将行转换为列
stacked = df.stack()
unstacked = stacked.unstack()
```

### 高级时间序列处理

#### `date_range()` 方法

```python
# 创建一个日期范围
pd.date_range(start='2021-01-01', end='2021-12-31', freq='D') # 频率为天
```

#### 时间序列窗口函数

```python
# 对时间序列数据应用滚动窗口函数，如移动平均
df['日期列'].rolling(window=3).mean()
```

### 文本数据处理

#### 文本数据清洗

```python
# 清洗和预处理文本数据，如删除空格、转换大小写
df['文本列'] = df['文本列'].str.strip().str.lower()
```

#### 文本数据聚合

```python
# 对文本数据进行聚合，如词频统计、文本分类等
df['文本列'].value_counts()
```

### 注意事项

>   1.   在使用多索引和透视表时，需要注意索引级别的正确设置，以避免数据混乱
>   2.   在进行性能优化时，选择合适的方法和技巧可以显著提高数据分析的效率
>   3.   在进行数据转换和重塑时，需要根据数据的特点和分析需求选择合适的方法